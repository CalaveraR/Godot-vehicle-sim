# res://core/integration/TireRigidBodyApplicator.gd
class_name TireRigidBodyApplicator
extends RefCounted

## Centralized force application for tire physics.
##
## This utility applies forces and torques to a RigidBody3D based on a
## dictionary of force components and an optional torque vector.
## It supports applying the force at a specific world-space point.
##
## The forces dictionary is expected to contain keys "Fx", "Fy", "Fz"
## representing the linear force vector in Godot's coordinate system
## (X: right, Y: up, Z: forward). Additional keys "Mx", "My", "Mz" can
## be used as a fallback torque if the explicit `torque` parameter is zero.
##
## Usage:
##   var applicator = TireRigidBodyApplicator.new()
##   applicator.apply(vehicle_body, {"Fx": 100, "Fy": 0, "Fz": 50}, Vector3.ZERO, Vector3.ZERO)

## Apply forces and torque to a rigid body.
##
## @param body      The RigidBody3D to apply forces to.
## @param forces    Dictionary with at least "Fx", "Fy", "Fz". May also include
##                  "Mx", "My", "Mz" for torque fallback.
## @param torque    Explicit torque vector (if non‑zero, it overrides torque from forces).
## @param at_ws     World‑space point where the linear force is applied.
##                  If zero or equal to body.global_position, a central force is applied.
func apply(body: RigidBody3D, forces: Dictionary, torque: Vector3, at_ws: Vector3) -> void:
    if not is_instance_valid(body):
        return

    # Extract linear force from dictionary
    var linear_force := Vector3(
        forces.get("Fx", 0.0),
        forces.get("Fy", 0.0),
        forces.get("Fz", 0.0)
    )

    # Apply linear force
    if at_ws == Vector3.ZERO or at_ws.is_equal_approx(body.global_position):
        body.apply_central_force(linear_force)
    else:
        body.apply_force(linear_force, at_ws - body.global_position)

    # Apply torque
    if torque != Vector3.ZERO:
        body.apply_torque(torque)
    else:
        # Fallback: try to extract torque from dictionary
        var torque_from_dict := Vector3(
            forces.get("Mx", 0.0),
            forces.get("My", 0.0),
            forces.get("Mz", 0.0)
        )
        if torque_from_dict != Vector3.ZERO:
            body.apply_torque(torque_from_dict)